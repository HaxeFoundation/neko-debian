#!/usr/bin/make -f
## debian/rules for neko.

%:
	dh $@ --with bash-completion

## Both AMD64 and all kFreeBSDs seem to have problems with the type
## punning used in the Neko source.
ifeq (amd64,$(DEB_HOST_ARCH))
export DEB_CFLAGS_MAINT_APPEND = -fno-strict-aliasing
endif
ifeq (kfreebsd,$(DEB_HOST_ARCH_OS))
export DEB_CFLAGS_MAINT_APPEND = -fno-strict-aliasing
endif

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

override_dh_auto_configure:
	dh_auto_configure -- -DSTATIC_DEPS=MbedTLS -DCMAKE_SKIP_RPATH=ON -DRUN_LDCONFIG=OFF -DCMAKE_INSTALL_LIBDIR=lib/$(DEB_HOST_MULTIARCH)

# dh_shlibdeps does not see the ndll files as libraries, so we call dpkg-shlibdeps manually
override_dh_shlibdeps:
	dh_shlibdeps
	dpkg-shlibdeps -Tdebian/neko.substvars debian/neko/usr/bin/* debian/neko/usr/lib/neko/*.ndll

override_dh_install:
	for file in debian/*.in; \
	do \
		sed 's/@DEB_HOST_MULTIARCH@/$(DEB_HOST_MULTIARCH)/g' $${file} > $${file%%.in}; \
	done
	dh_install

override_dh_clean:
	dh_clean
	for file in debian/*.in; \
	do \
		rm -f $${file%%.in}; \
	done

get-orig-source:
	uscan --verbose --rename --force-download
